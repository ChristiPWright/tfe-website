<?xml version="1.0" encoding="UTF-8"?>

<screen require-authentication="anonymous-view" allow-extra-path="true"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd">

    <parameter name="productId"/>
    <parameter name="addedCorrect"/>
    <parameter name="categoryId"/>

    <transition name="addToCart">
        <actions>
            <service-call name="tfe-website.CartServices.add#Product" out-map="addOut"
                in-map="[productId:productId, quantity:quantity, currencyUomId:currencyUomId]"/> 
                <set field="addedCorrect" from="false"/>
                <if condition="addOut.orderHeader != null">
                    <set field="addedCorrect" from="true"/>
                </if>
            <log message="======================================= addToCart transition hit============" />
        </actions>
        <conditional-response url="."><condition><expression>categoryId != null</expression></condition><parameter name="categoryId"/><parameter name="addedCorrect"/></conditional-response>
        <conditional-response url="."><condition><expression>searchParameter != null</expression></condition><parameter name="searchParameter"/><parameter name="addedCorrect"/></conditional-response>
        <default-response url="."><parameter name="addedCorrect"/></default-response>
        <error-response url="."/>
    </transition>

    <transition name="removeCartItem">
        <actions>
            <service-call name="tfe-website.CartServices.delete#OrderItem" in-map="[orderId: orderId, orderItemSeqId: orderItemSeqId]"/>
            <if condition="categoryId != null">
                <set field="categoryId" from="categoryId"/>
                <set field="categoryName" from="categoryName"/>
            </if>
            <if condition="searchParameter != null">
                <set field="searchParameter" from="searchParameter"/>
            </if>
        </actions>
        <conditional-response url="."><condition><expression>categoryId != null</expression></condition><parameter name="categoryId"/><parameter name="addedCorrect"/></conditional-response>
        <conditional-response url="."><condition><expression>searchParameter != null</expression></condition><parameter name="searchParameter"/><parameter name="addedCorrect"/></conditional-response>
        <default-response url="."/>
    </transition>

    <pre-actions>
        <set field="imgContent" from="[]"/>
        <!-- Sri & screenURLInfo both refer to lower down in moqui, not entirely sure of each line but required to render the indiv product path -->
        <set field="extraPathNameList" from="sri.screenUrlInfo.extraPathNameList"/>
        <if condition="searchParameter"><set field="searchParameter" from="URLEncoder.encode(searchParameter, 'UTF-8')"/></if>
        <if condition="extraPathNameList &amp;&amp; !productId"><set field="productId" from="extraPathNameList[0]"/></if>

        <log message="tfe-website/product::::contentList-----------------------${imgContent}--------------------------------------" />
    </pre-actions>

    <actions>
        <service-call name="tfe-website.ProductServices.get#ProductInfo" out-map="product" in-map="[productId:productId]"/>
        <log message="tfe-website/product::::product-----------------------${product}--------------------------------------" />
        <!-- Added quantity to Product Info service -->
        <!-- Added availability to Product Info service -->
        <service-call name="tfe-website.CartServices.get#CartInfo" in-map="context" out-map="productsInCart" />
        
        <log message="tfe-website/product::::product.productAvailability-----------------------${product.productAvailability}--------------------------------------" />
        
              
        <if condition="categoryId">
            <service-call name="tfe-website.ProductServices.get#CategoryInfo" out-map="category" in-map="[productCategoryId:categoryId]"/>
        </if>
        
        <!-- <set field="specialInstrLocation" from="product.contentList.find({'PcntSpecialInstr' == it.productContentTypeEnumId})?.contentLocation"/>
        <if condition="specialInstrLocation">
            <set field="specialInstructions" from="ec.resource.getLocationText(specialInstrLocation, true)"/>
        </if> -->
        <!-- <set field="faqLocation" from="product.contentList.find({'PcntFAQ' == it.productContentTypeEnumId})?.contentLocation"/>
        <if condition="faqLocation">
            <set field="faq" from="ec.resource.getLocationText(faqLocation, true)"/>
        </if> -->
        <!-- <set field="lifestyleLocation" from="product.contentList.find({'PcntDirections' == it.productContentTypeEnumId})?.contentLocation"/>
        <if condition="lifestyleLocation">
            <set field="lifestyle" from="ec.resource.getLocationText(lifestyleLocation, true)"/>
        </if>
        <set field="labelLocation" from="product.contentList.find({'PcntLabelText' == it.productContentTypeEnumId})?.contentLocation"/>
        <if condition="labelLocation">
            <set field="label" from="ec.resource.getLocationText(labelLocation, true)"/>
        </if> -->
        <set field="imageLabel" from="product.contentList.find({'PcntLabelImage' == it.productContentTypeEnumId})"/>
        <set field="imageDetail" from="product.contentList.find({'PcntImageDetail' == it.productContentTypeEnumId})"/>
        <set field="transparencyLocation" from="product.contentList.find({'PcntProductTransparency' == it.productContentTypeEnumId})?.contentLocation"/>
        <if condition="transparencyLocation">
            <set field="transparency" from="ec.resource.getLocationText(transparencyLocation, true)"/>
        </if>
    </actions>   

    <widgets>
        
        <render-mode>
            <text type="html" location="component://tfe-website/template/tfe-website/product.html.ftl"/>
        </render-mode>
        
    </widgets>
</screen>
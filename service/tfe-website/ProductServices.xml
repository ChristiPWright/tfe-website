<?xml version="1.0" encoding="UTF-8"?>

<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">
    <service verb="get" noun="CategoryProducts">
        <in-parameters>
        </in-parameters>

        <out-parameters>
            <parameter name="productList" type="List">
                <parameter name="productInfo" type="Map">
                    <parameter name="productId"/>
                    <parameter name="productId"/>
                    <parameter name="pseudoId"/>
                    <parameter name="productName"/>
                    <parameter name="description"/>
                    <parameter name="price" type="BigDecimal"/>
                    <parameter name="priceUomId"/>
                    <parameter name="smallImageInfo" type="Map"/>
                    <parameter name="mediumImageInfo" type="Map"/>
                </parameter>
            </parameter>
        </out-parameters>

        <actions>
            <!-- Get all products in the category -->
            <!-- use the name 'productList' so pagination out-parameters are created automatically -->
            <entity-find entity-name="mantle.product.category.ProductCategoryMember" list="productList" cache="true">
                <econdition field-name="productCategoryId" value="ProdCat"/>
            </entity-find>
            <set field="pcmList" from="productList"/>

            <!-- Array to catch out variables from below iterating loop -->
            <set field="productList" from="[]"/>
            
            <!-- For Loop -->
            <!-- Find entity & all associated entities. Get Product, Price, Content -->
            <iterate list="pcmList" entry="pcmp">
                <!-- In each iteration Gets individual product entity -->
                <entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true">
                    <field-map field-name="productId" from="pcmp.productId"/></entity-find-one>

                <!-- Uses indiv defined product to access imag content image based on productContentTypeEnumID -->
                <set field="smallImageInfo" from="null"/>
                <set field="mediumImageInfo" from="null"/>
                <entity-find entity-name="mantle.product.ProductContent" list="productContentList" cache="true">
                    <econdition field-name="productId" from="pcmp.productId"/>
                </entity-find>

                <!-- Finds all content in the local language -->
                <if condition="locale">
                    <!-- filter after by locale to streamline cached find -->
                    <set field="langLocale" from="locale.contains('_') ? locale.substring(locale.indexOf('_')) : null"/>
                    <set field="productContentList" from="productContentList.findAll({ it.locale == null || it.locale == locale || it.locale == langLocale })"/>
                </if>
                <if condition="productContentList">
                    <!-- medium can be PcntImageMedium or PcntImageLarge -->
                    <set field="mediumImageInfo" from="productContentList.find({ 'PcntImageMedium'.equals(it.productContentTypeEnumId) })"/>
                    <if condition="mediumImageInfo == null">
                        <set field="mediumImageInfo" from="productContentList.find({ 'PcntImageLarge'.equals(it.productContentTypeEnumId) })"/></if>
                    <!-- small can be PcntImageSmall or from medium we just looked up -->
                    <set field="smallImageInfo" from="productContentList.find({ 'PcntImageSmall'.equals(it.productContentTypeEnumId) })"/>
                    <if condition="smallImageInfo == null"><set field="smallImageInfo" from="mediumImageInfo"/></if>
                </if>
                      
                <script>productList.add([productId:pcmp.productId,pseudoId:product.pseudoId,productName:product.productName, description:product.description, price:product.prices.price[0],priceUomId:product.prices.priceUomId[0],smallImageInfo:smallImageInfo, mediumImageInfo:mediumImageInfo])</script>
                    
            </iterate>

            

            <log message="tfe-website::::productList-----------------------${productList}--------------------------------------" />
            <log message="tfe-website::::pcmList-----------------------${pcmList}--------------------------------------" />
            <log message="tfe-website::::product-----------------------${product}--------------------------------------" />
            <log message="tfe-website::::price-----------------------${price}--------------------------------------" />
            
        </actions>

    </service>
</services>